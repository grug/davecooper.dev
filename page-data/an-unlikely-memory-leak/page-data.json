{"componentChunkName":"component---src-templates-blog-post-js","path":"/an-unlikely-memory-leak/","result":{"data":{"site":{"siteMetadata":{"title":"davecooper.dev"}},"markdownRemark":{"id":"d73805a4-ba63-55e1-b5b0-22714099e6d6","excerpt":"Here’s a pretty interesting bug that a mate recently ran into that piqued my interest. Picture this: you’re writing an MVP for an application which has some…","html":"<p>Here’s a pretty interesting bug that a mate recently ran into that piqued my interest.</p>\n<p>Picture this: you’re writing an MVP for an application which has some data access components - it might look like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">MyComponent</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">$http</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>$http <span class=\"token operator\">=</span> $http<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token function\">doSomething</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>$http<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'http://myapi.com/some-endpoint'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">response</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>data <span class=\"token operator\">=</span> response<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This probably looks familiar to a lot of you Angular developers out there.</p>\n<p>Pretty innocuous, right?</p>\n<p>What if I were to say that there is a reasonably annoying potential memory leak here? Most people I’ve spoken to have either scoffed or tried <em>really</em> hard to find something in the code that isn’t there.</p>\n<p>Let’s take a look at what happens as this code ran over time:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c2ded693abfd7e9930b272370b66ef9e/21b4d/memory-usage.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 17.567567567567565%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsSAAALEgHS3X78AAAAd0lEQVQY05WM7Q7CIAxFef9XlcLGtiotcNcGNZr9MN7k5PQjbYgxYiFCyguoJNyszzkZBKKElVarM5gZB98nB2PbrxQj4EfamGhzxtvdZsPBtMfnodvGqdoh+mGZbm3uX0ffGReHslc8qqJWgYjaE7UnxtOq/3ECpI06BzUK9LgAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Memory usage\"\n        title=\"Memory usage\"\n        src=\"/static/c2ded693abfd7e9930b272370b66ef9e/fcda8/memory-usage.png\"\n        srcset=\"/static/c2ded693abfd7e9930b272370b66ef9e/12f09/memory-usage.png 148w,\n/static/c2ded693abfd7e9930b272370b66ef9e/e4a3f/memory-usage.png 295w,\n/static/c2ded693abfd7e9930b272370b66ef9e/fcda8/memory-usage.png 590w,\n/static/c2ded693abfd7e9930b272370b66ef9e/efc66/memory-usage.png 885w,\n/static/c2ded693abfd7e9930b272370b66ef9e/c83ae/memory-usage.png 1180w,\n/static/c2ded693abfd7e9930b272370b66ef9e/21b4d/memory-usage.png 1280w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Hmm… interesting. We seem to be building up a fair bit of memory usage and nothing seems to be garbage collected. Why?</p>\n<p>It’s probably not going to be the constructor for this class, so let’s write that off. I’ll also add in the assumption that Angular’s <code class=\"language-text\">$http</code> service isn’t causing any leaks for us here (although it might do - but that’s a separate discussion alogether). This leaves us with the <code class=\"language-text\">doSomething()</code> function. We’ve all retrieved data like this in Angular applications a billion times before without any problems, right?</p>\n<p>The solution to answering <em>why</em> this memory usage was accumulating had to do with how frequently <code class=\"language-text\">doSomething()</code> was being hit and the size of the data that was being returned in the response to the API call.</p>\n<p>What was happening that certainly widened my eyes was that the <code class=\"language-text\">console.log(response)</code> was keeping a reference to <code class=\"language-text\">response</code> and thus not being garbage collected. I thought this was super strange because I couldn’t work out why.</p>\n<p>By now, some people have probably worked this out. The browser developer tools uses this reference which allows us to inspect objects while we’ve logged! One of the reasons why you shouldn’t keep client-side logging in your production code.</p>\n<p>This is how things look once the logging line is removed:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/30d1daf35e56df3bbbc5d9ed57b53d49/21b4d/after-collection.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 17.567567567567565%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsSAAALEgHS3X78AAAAhUlEQVQY042MUQ7DIAxDuf9RCS3bCJUKCV6AdV3VnyE9OcZOnPeE1XuEsIAeAZ4IRB7rYrNlkaJlAZwSti2DOSMx45UY8cnD53zi8MfTBlS50v+K3LtOLami2Iui1Km7NX+9WN57ndbsUgftm3c9Zpe2Osw8KkNF9bOs48DUE9UrcqjtvgEryznPP5YOqQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"After collection\"\n        title=\"After collection\"\n        src=\"/static/30d1daf35e56df3bbbc5d9ed57b53d49/fcda8/after-collection.png\"\n        srcset=\"/static/30d1daf35e56df3bbbc5d9ed57b53d49/12f09/after-collection.png 148w,\n/static/30d1daf35e56df3bbbc5d9ed57b53d49/e4a3f/after-collection.png 295w,\n/static/30d1daf35e56df3bbbc5d9ed57b53d49/fcda8/after-collection.png 590w,\n/static/30d1daf35e56df3bbbc5d9ed57b53d49/efc66/after-collection.png 885w,\n/static/30d1daf35e56df3bbbc5d9ed57b53d49/c83ae/after-collection.png 1180w,\n/static/30d1daf35e56df3bbbc5d9ed57b53d49/21b4d/after-collection.png 1280w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>As you can see, the garbage collector is now able to kick in and remove references to our objects. I’ll also add here that this problem would arise regardless of the framework used here. It will happen even if you craft an XHR request manually and log the results.</p>\n<p>I’m not ashamed to admit that I didn’t work this one out myself, but I certainly loved learning about it and trying to assist in diagnosing it.</p>\n<p>Let me know what you think about this!</p>\n<p>-Dave</p>","timeToRead":2,"frontmatter":{"title":"Unlikely Memory Leak","date":"February 05, 2017","description":"Explanation of a memory leak caused by JavaScript's console.log()"}}},"pageContext":{"slug":"/an-unlikely-memory-leak/","previous":{"fields":{"slug":"/command-line-advertising/"},"frontmatter":{"title":"Command line advertising: coming to a terminal near you!"}},"next":{"fields":{"slug":"/injecting-mock-data-into-applications-in-2019/"},"frontmatter":{"title":"Injecting mock data into applications in 2019"}}}}}